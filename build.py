#!/usr/bin/env python

from plumbum import local
import sys
import os

DEFAULT_VERSION = '0.9.0'
TARGETS = ('linux', 'darwin', 'windows')


def build_client(target, version=DEFAULT_VERSION):
    print("Building target: %s" % target)

    repository_folder = local['git']['rev-parse', '--show-toplevel']().strip()
    gopath = f'{repository_folder}'

    with local.env(GOPATH=f'/{gopath}'):
        print("Getting go dependencies...")
        local['go']['get', './src/pentest'](stdout=sys.stdout, stderr=sys.stderr)
        target_path = f'{gopath}/bin/{target}/pentest'
        print("Done.")
        print("Building...")
        cmd = local['go']['build', '-o', target_path, 'pentest']
        cmd(stdout=sys.stdout, stderr=sys.stderr)
        os.chmod(target_path, 0o555)
        print("Done.")

    return target_path


if __name__ == '__main__':
    if len(sys.argv) > 1:
        version = sys.argv[1]
    else:
        version = DEFAULT_VERSION
    for target in TARGETS:
        with local.env(GOOS=target, GOARCH='amd64'):
            build_client(target, version)
