package testers

import (
	"context"
	"database/sql"
	"fmt"
	"github.com/go-sql-driver/mysql"
	"io/ioutil"
	"log"
	"pentest/engine"
	"time"
)

import _ "github.com/go-sql-driver/mysql"

type MysqlTester struct{}

func GenerateMysqlDSNWithCreds(target engine.Target, timeout time.Duration, creds engine.Credential) string {
	url := ""
	if creds.Username != "" {
		url += creds.Username
		if creds.Password != "" {
			url += ":" + creds.Password
		}
		url += "@"
	}
	url += fmt.Sprintf("tcp(%s:%d)/?timeout=%v&writeTimeout=%v&readTimeout=%v", target.IP, target.Port,
		timeout, timeout, timeout)
	return url
}

func GenerateMysqlDSN(target engine.Target, timeout time.Duration) string {
	return GenerateMysqlDSNWithCreds(target, timeout, engine.Credential{})
}

func CheckMysql(dsn string) bool {
	mysql.SetLogger(log.New(ioutil.Discard, "mysql", 0))

	db, err := sql.Open("mysql", dsn)

	if err != nil {
		fmt.Println("Shouldn't happen.")
		return false
	}
	defer db.Close()

	conn, err := db.Conn(context.Background())
	if err != nil {
		return false
	}
	defer conn.Close()

	return true
}

func (_ MysqlTester) Test(target engine.Target) {
	timeout := 50 * time.Millisecond

	if CheckMysql(GenerateMysqlDSN(target, timeout)) {
		fmt.Printf("Mysql: Default credentials open!\n")
		return
	}

	for creds := range engine.GenerateCredentials() {
		fmt.Printf("MySQL: Trying using %s:%s\n", creds.Username, creds.Password)
		if CheckMysql(GenerateMysqlDSNWithCreds(target, timeout, creds)) {
			fmt.Printf("Mysql: Connected!")
			return
		}
	}
}

func init () {
	fmt.Println("Loading Mysql Tester")

	engine.AddTester(MysqlTester{})
}
