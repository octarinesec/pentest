package testers

import (
	"fmt"
	"github.com/globalsign/mgo"
	"pentest/engine"
	"time"
)

type MongoDBTester struct{}

func generateMongoURIWithCreds(target engine.Target, creds engine.Credentials) string {
	url := "mongodb://"
	if creds.Username != "" {
		url += creds.Username
		if creds.Password != "" {
			url += ":" + creds.Password
		}
		url += "@"
	}
	url += fmt.Sprintf("%s:%d", target.IP, target.Port)
	return url
}

func generateMongoURI(target engine.Target) string {
	return GenerateMongoURIWithCreds(target, engine.Credentials{})
}

func checkMongoDB(uri string) bool {
	session, err := mgo.DialWithTimeout(uri, 50*time.Millisecond)
	if err != nil {
		return false
	}

	session.Close()
	return true
}

func (tester MongoDBTester) Test(target engine.Target) {
	if checkMongoDB(generateMongoURI(target)) {
		engine.AddTestResult(tester, target, "Default credentials")

		engine.Logger.Infof("MongoDB: Default credentials open on %s!\n", target)
		return
	}

	for creds := range engine.GenerateCredentials() {
		engine.Logger.Debugf("MongoDB: Trying using %s:%s\n", creds.Username, creds.Password)
		if checkMongoDB(generateMongoURIWithCreds(target, creds)) {

			engine.AddTestResult(tester, target, creds)

			engine.Logger.Infof("==== MongoDB: Connected to %s using %s:%s!", target, creds.Username, creds.Password)
			return
		}
	}
}

func init() {
	engine.Logger.Debugf("Adding MongoDB Tester")

	engine.AddTester(MongoDBTester{})
}
