package engine

import (
	"fmt"
	"net"
	"time"
)

type Target struct {
	IP 		string
	Port 	uint16
}

func (t Target) String() string {
	return fmt.Sprintf("%s:%d", t.IP, t.Port)
}

type Targets struct {
	ips		[]string
	ports	[]uint16
}

var targets Targets

func AddIP(ip string) {
	for _, exists := range targets.ips {
		if exists == ip {
			return
		}
	}

	fmt.Printf("Collecting ip: %v\n", ip)
	targets.ips = append(targets.ips, ip)
}

func AddPort(port uint16) {
	for _, exists := range targets.ports {
		if exists == port {
			return
		}
	}

	fmt.Printf("Collecting port: %v\n", port)
	targets.ports = append(targets.ports, port)
}

func IsTargetReachable(target Target) bool {

	conn, err := net.DialTimeout("tcp", target.String(), time.Millisecond * 50)
	if err != nil {
		return false
	}
	conn.Close()

	return true
}

func GenerateTarget() <- chan Target {
	ch := make(chan Target)
	go func () {
		for _, ip := range targets.ips {
			for _, port := range targets.ports {
				target := Target{ip, port}
				if IsTargetReachable(target) {
					ch <- target
				}
			}
		}
		close(ch)
	} ()
	return ch
}
